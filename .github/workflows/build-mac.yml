name: Build Windows and macOS App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-mac:
    name: Build macOS App
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller matplotlib

      - name: Locate entry + icns
        shell: bash
        run: |
          ENTRY="$(find . -maxdepth 8 -type f -iname 'w1te_macro.py' -print -quit)"
          ICON="$(find . -maxdepth 8 -type f -iname 'icon.icns' -print -quit)"

          echo "ENTRY=$ENTRY" >> "$GITHUB_ENV"
          echo "ICON=$ICON"   >> "$GITHUB_ENV"

          echo "ENTRY = $ENTRY"
          echo "ICON  = $ICON"

          if [ -z "$ENTRY" ]; then
            echo "ERROR: w1te_macro.py not found"
            exit 1
          fi
          if [ -z "$ICON" ]; then
            echo "ERROR: icon.icns not found"
            exit 1
          fi

      - name: Build macOS
        shell: bash
        run: |
          python -m PyInstaller --noconfirm --clean --windowed --onefile \
            --name W1teMacro \
            --icon "$ICON" \
            --collect-all matplotlib \
            --hidden-import matplotlib.backends.backend_tkagg \
            --hidden-import matplotlib.backends._backend_tk \
            --hidden-import matplotlib.backends._tkagg \
            "$ENTRY"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: W1teMacro-macOS
          path: dist/


  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller matplotlib

      - name: Locate entry + ico
        shell: pwsh
        run: |
          $entry = Get-ChildItem -Recurse -File | Where-Object { $_.Name -ieq "w1te_macro.py" } | Select-Object -First 1
          if (-not $entry) { throw "ERROR: w1te_macro.py not found" }

          $ico = Get-ChildItem -Recurse -File | Where-Object { $_.Name -ieq "icon.ico" } | Select-Object -First 1
          if (-not $ico) { throw "ERROR: icon.ico not found" }

          "ENTRY=$($entry.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "ICON=$($ico.FullName)"   | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          Write-Host "ENTRY = $($entry.FullName)"
          Write-Host "ICON  = $($ico.FullName)"

      - name: Sanity check matplotlib TkAgg
        shell: pwsh
        run: |
          python -c "import matplotlib; print('matplotlib OK:', matplotlib.__version__)"
          python -c "from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg; print('TkAgg OK')"

      - name: Build Windows EXE
        shell: pwsh
        run: |
          python -m PyInstaller --noconfirm --clean --windowed --onefile `
            --name W1teMacro `
            --icon "$env:ICON" `
            --collect-all matplotlib `
            --hidden-import matplotlib.backends.backend_tkagg `
            --hidden-import matplotlib.backends._backend_tk `
            --hidden-import matplotlib.backends._tkagg `
            "$env:ENTRY"

          if (Test-Path dist) { dir dist } else { throw "dist folder not found (build failed)" }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: W1teMacro-Windows
          path: dist/
