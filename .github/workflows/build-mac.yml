name: Build macOS App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-mac:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller matplotlib

      - name: Locate entry + icon
        shell: bash
        run: |
          ENTRY="$(find . -maxdepth 6 -type f -iname 'w1te_macro.py' -print -quit)"
          ICON="$(find . -maxdepth 8 -type f -iname 'icon.icns' -print -quit)"

          echo "ENTRY=$ENTRY" >> "$GITHUB_ENV"
          echo "ICON=$ICON"   >> "$GITHUB_ENV"

          echo "ENTRY = $ENTRY"
          echo "ICON  = $ICON"

          if [ -z "$ENTRY" ]; then
            echo "ERROR: w1te_macro.py not found"
            exit 1
          fi
          if [ -z "$ICON" ]; then
            echo "ERROR: icon.icns not found"
            exit 1
          fi

      - name: Build macOS
        shell: bash
        run: |
          python -m PyInstaller --noconfirm --clean --windowed --onefile \
            --name W1teMacro \
            --icon "$ICON" \
            --collect-all matplotlib \
            --hidden-import matplotlib.backends.backend_tkagg \
            --hidden-import matplotlib.backends._backend_tk \
            --hidden-import matplotlib.backends._tkagg \
            "$ENTRY"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: W1teMacro-macOS
          path: dist/
